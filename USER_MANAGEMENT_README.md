# ğŸ” AIezzy Enhanced User Management System

Production-grade user authentication, authorization, and management system with PostgreSQL support, email verification, OAuth social login, usage quotas, and comprehensive admin dashboard.

## âœ¨ Features

### ğŸ¯ Core Authentication
- âœ… **User Registration** with email validation
- âœ… **Email Verification** via SendGrid (optional)
- âœ… **Password Reset** with secure token-based flow
- âœ… **Session Management** with 30-day persistent sessions
- âœ… **Secure Password Hashing** (SHA256 + salt)

### ğŸŒ OAuth Social Login
- âœ… **Google OAuth** - Sign in with Google account
- âœ… **GitHub OAuth** - Sign in with GitHub account
- âœ… **Account Linking** - Connect multiple login methods
- âœ… **Auto-Registration** - Creates account on first OAuth login

### ğŸ“Š Usage Tracking & Quotas
- âœ… **Tier-Based Limits** - Free, Pro, Enterprise tiers
- âœ… **Resource Tracking** - Images, videos, messages
- âœ… **Daily Quotas** - Automatic reset at midnight UTC
- âœ… **Usage Analytics** - Historical data and trends
- âœ… **Quota Enforcement** - Prevents over-usage

### ğŸ› ï¸ Admin Dashboard
- âœ… **User Management** - View, edit, activate/deactivate users
- âœ… **Usage Analytics** - Monitor system-wide and per-user usage
- âœ… **Tier Management** - Upgrade/downgrade user tiers
- âœ… **Real-time Stats** - Active sessions, new users, usage metrics
- âœ… **Activity Logs** - Track user actions and login history

### ğŸ’¾ Database Support
- âœ… **PostgreSQL** - Production-ready, scalable (Railway)
- âœ… **SQLite** - Development-friendly, zero config
- âœ… **Auto-Migration** - Seamless upgrade from old schema
- âœ… **Data Preservation** - Migrates existing users and sessions

## ğŸš€ Quick Start

### 1. Install Dependencies

```bash
pip install -r requirements.txt
```

### 2. Run Setup Wizard

```bash
python setup.py
```

This will:
- Create `.env` from template
- Initialize database
- Optionally create admin user
- Provide next steps

### 3. Configure Environment

Edit `.env` file with your API keys:

```env
# Required
SECRET_KEY=<auto-generated-32-char-key>
OPENAI_API_KEY=sk-...
FAL_KEY=...

# Optional (Email)
SENDGRID_API_KEY=SG....
SENDGRID_FROM_EMAIL=noreply@yourdomain.com

# Optional (OAuth)
GOOGLE_CLIENT_ID=...
GOOGLE_CLIENT_SECRET=...
GITHUB_CLIENT_ID=...
GITHUB_CLIENT_SECRET=...
```

### 4. Start Application

```bash
python web_app.py
```

Visit: http://localhost:5000

## ğŸ“š API Documentation

### Authentication Endpoints

#### Register User
```http
POST /api/v2/register
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "secure_password",
  "full_name": "John Doe"
}
```

**Response:**
```json
{
  "success": true,
  "user": { "id": 1, "email": "user@example.com", ... },
  "session_token": "abc123...",
  "message": "Registration successful"
}
```

#### Login
```http
POST /api/v2/login
Content-Type: application/json

{
  "username": "user@example.com",
  "password": "secure_password"
}
```

**Response:**
```json
{
  "success": true,
  "user": { "id": 1, "email": "user@example.com", ... },
  "session_token": "abc123..."
}
```

#### Verify Email
```http
GET /api/v2/verify-email?token=<verification_token>
```

#### Request Password Reset
```http
POST /api/v2/forgot-password
Content-Type: application/json

{
  "email": "user@example.com"
}
```

#### Reset Password
```http
POST /api/v2/reset-password
Content-Type: application/json

{
  "token": "<reset_token>",
  "password": "new_secure_password"
}
```

### OAuth Endpoints

#### Initiate OAuth Login
```http
GET /api/oauth/login/{provider}

Where provider = google | github
```

#### OAuth Callback (automatic)
```http
GET /api/oauth/callback/{provider}?code=...&state=...
```

### Quota Endpoints

#### Get Quota Status
```http
GET /api/v2/quota/status
Authorization: Bearer <session_token>
```

**Response:**
```json
{
  "tier": "free",
  "limits": {
    "images": 20,
    "videos": 5,
    "messages": 100
  },
  "usage": {
    "image": 5,
    "video": 1,
    "message": 23
  },
  "remaining": {
    "image": 15,
    "video": 4,
    "message": 77
  }
}
```

### Admin Endpoints

All admin endpoints require admin privileges.

#### Get Dashboard Data
```http
GET /api/admin/dashboard
Authorization: Bearer <admin_session_token>
```

#### Update User Tier
```http
POST /api/admin/users/{user_id}/tier
Content-Type: application/json
Authorization: Bearer <admin_session_token>

{
  "tier": "pro"
}
```

#### Deactivate User
```http
POST /api/admin/users/{user_id}/deactivate
Authorization: Bearer <admin_session_token>
```

## ğŸ’° Tier System

### Free Tier (Default)
- 20 images per day
- 5 videos per day
- 100 messages per day
- Full feature access

### Pro Tier
- 200 images per day
- 50 videos per day
- 1,000 messages per day
- Priority support

### Enterprise Tier
- Unlimited usage
- Dedicated resources
- Custom quotas
- SLA guarantees

### Customizing Quotas

Edit `.env`:

```env
QUOTA_FREE_IMAGES=20
QUOTA_FREE_VIDEOS=5
QUOTA_FREE_MESSAGES=100

QUOTA_PRO_IMAGES=200
QUOTA_PRO_VIDEOS=50
QUOTA_PRO_MESSAGES=1000
```

Or set dynamically via admin dashboard.

## ğŸ¨ Frontend Integration

### Show Quota Status

```javascript
// Load quota on page load
async function loadQuota() {
    const response = await fetch('/api/v2/quota/status', {
        headers: {
            'Authorization': `Bearer ${localStorage.getItem('session_token')}`
        }
    });

    const quota = await response.json();

    // Display quota
    document.getElementById('images-used').textContent = quota.usage.image;
    document.getElementById('images-limit').textContent = quota.limits.images;

    // Show warning if low
    if (quota.remaining.image < 5) {
        showWarning('You have only ' + quota.remaining.image + ' images remaining today!');
    }
}
```

### Enforce Quota Before API Call

```javascript
async function generateImage(prompt) {
    // Check quota first
    const quota = await fetch('/api/v2/quota/status').then(r => r.json());

    if (quota.remaining.image <= 0) {
        alert('Daily image limit reached! Upgrade to Pro for more.');
        return;
    }

    // Proceed with generation
    const response = await fetch('/api/chat', {
        method: 'POST',
        body: JSON.stringify({ message: 'generate image: ' + prompt }),
        headers: { 'Content-Type': 'application/json' }
    });

    // Refresh quota after generation
    loadQuota();
}
```

### OAuth Login Buttons

```html
<div class="oauth-login">
    <button onclick="loginWithGoogle()">
        <img src="/static/google-icon.png" /> Sign in with Google
    </button>
    <button onclick="loginWithGitHub()">
        <img src="/static/github-icon.png" /> Sign in with GitHub
    </button>
</div>

<script>
function loginWithGoogle() {
    window.location.href = '/api/oauth/login/google';
}

function loginWithGitHub() {
    window.location.href = '/api/oauth/login/github';
}
</script>
```

## ğŸ”§ Configuration

### Email Settings (SendGrid)

1. Create SendGrid account (free tier: 100 emails/day)
2. Create API key with full access
3. Verify sender email or domain
4. Add to `.env`:

```env
SENDGRID_API_KEY=SG.your-key-here
SENDGRID_FROM_EMAIL=noreply@yourdomain.com
SENDGRID_FROM_NAME=AIezzy
EMAIL_VERIFICATION_REQUIRED=true  # or false for dev
```

### OAuth Setup

#### Google OAuth

1. Go to [Google Cloud Console](https://console.cloud.google.com/)
2. Create project â†’ Enable Google+ API
3. Create OAuth credentials
4. Add redirect URI: `https://yourdomain.com/api/oauth/callback/google`
5. Copy client ID and secret to `.env`

#### GitHub OAuth

1. Go to [GitHub Settings](https://github.com/settings/developers)
2. New OAuth App
3. Add callback URL: `https://yourdomain.com/api/oauth/callback/github`
4. Copy client ID and secret to `.env`

### Database Configuration

#### Development (SQLite)

No configuration needed! Just leave `DATABASE_URL` empty in `.env`.

#### Production (PostgreSQL on Railway)

1. Add PostgreSQL plugin to Railway project
2. Railway auto-sets `DATABASE_URL`
3. Your app automatically uses PostgreSQL

## ğŸ—‚ï¸ File Structure

```
aiezzy-ai-chatbot-master/
â”œâ”€â”€ config.py                    # Configuration management
â”œâ”€â”€ models_v2.py                 # Enhanced database models (SQLAlchemy)
â”œâ”€â”€ api_routes.py                # New API endpoints
â”œâ”€â”€ email_service.py             # Email sending via SendGrid
â”œâ”€â”€ oauth_service.py             # OAuth providers (Google, GitHub)
â”œâ”€â”€ quota_service.py             # Usage tracking and quotas
â”œâ”€â”€ migrate_database.py          # Database migration tool
â”œâ”€â”€ setup.py                     # Quick setup wizard
â”œâ”€â”€ requirements.txt             # Python dependencies (updated)
â”œâ”€â”€ .env.example                 # Environment template
â”œâ”€â”€ templates/
â”‚   â””â”€â”€ admin_dashboard.html     # Admin UI
â”œâ”€â”€ DEPLOYMENT_GUIDE.md          # Detailed deployment guide
â”œâ”€â”€ INTEGRATION_GUIDE.md         # Integration instructions
â””â”€â”€ USER_MANAGEMENT_README.md    # This file
```

## ğŸ“Š Database Schema

### Users Table
- id, username, email, password_hash
- is_active, is_admin, email_verified
- tier (free/pro/enterprise)
- profile_image, bio, preferences
- created_at, updated_at, last_login

### User Sessions
- session_token, user_id, expires_at
- ip_address, user_agent, is_active

### OAuth Accounts
- provider, provider_user_id, user_id
- access_token, refresh_token, profile_data

### Email Verifications
- token, email, user_id, expires_at, verified

### Password Resets
- token, user_id, expires_at, used, used_at

### Usage Logs
- user_id, resource_type, resource_count
- metadata, created_at

### Daily Usage (Aggregated)
- user_id, date
- images_generated, videos_created, messages_sent

## ğŸ”’ Security Features

- âœ… **Password Hashing** - SHA256 with random salt
- âœ… **Secure Tokens** - Cryptographically random tokens
- âœ… **Session Expiry** - Auto-invalidate old sessions
- âœ… **CSRF Protection** - State tokens for OAuth
- âœ… **Email Verification** - Prevent fake accounts
- âœ… **Rate Limiting** - Prevent abuse (quota system)
- âœ… **IP Logging** - Track suspicious activity
- âœ… **SQL Injection Prevention** - SQLAlchemy ORM
- âœ… **XSS Prevention** - Input sanitization

## ğŸ“ˆ Monitoring & Analytics

### Admin Dashboard

Access at `/admin` (requires admin privileges)

Features:
- Total users, new signups today
- Active sessions
- Today's image/video generation
- Recent users list
- Top users by usage
- User management actions

### Usage Analytics API

```python
from quota_service import quota_service

# Get user's usage over time
analytics = quota_service.get_usage_analytics(user_id, days=30)

# Returns:
# {
#   'period_days': 30,
#   'totals': {'images': 150, 'videos': 20, 'messages': 500},
#   'daily': [
#     {'date': '2025-01-01', 'images': 5, 'videos': 1, 'messages': 20},
#     ...
#   ]
# }
```

## ğŸš€ Deployment

See `DEPLOYMENT_GUIDE.md` for complete deployment instructions.

### Quick Railway Deployment

```bash
# 1. Add PostgreSQL plugin in Railway dashboard
# 2. Set environment variables
# 3. Deploy
git push origin main

# 4. Run migration (first time only)
railway run python migrate_database.py migrate

# 5. Create admin user
railway run python migrate_database.py create-admin admin admin@yourdomain.com secure123
```

## ğŸ¤ Contributing

When adding features:

1. Update database models in `models_v2.py`
2. Add routes to `api_routes.py`
3. Update frontend in templates
4. Test with both SQLite and PostgreSQL
5. Update documentation

## ğŸ“ Support

- Check `INTEGRATION_GUIDE.md` for integration help
- Check `DEPLOYMENT_GUIDE.md` for deployment issues
- Review logs for error messages
- Check Railway deployment logs

## ğŸ“„ License

Same as main AIezzy project.

---

**Built with â¤ï¸ for AIezzy**
Version 2.0 - Enhanced User Management System
